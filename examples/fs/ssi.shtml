<!DOCTYPE html>
<html lang="en">
<head>
    <title>DigiFLow 242</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">     
    <meta name="description" content="hedmanshome.se Marine Water FlowMeter">
    <meta name="author" content="Erland Hedman">
    <meta name="license" content="Free">
    <link rel="icon" href="drop.ico">

    <style>

    table {
        font-family: arial, sans-serif;
        border-collapse: collapse;
        width: 100%;
    }

    td, th {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 3px;
        width: 30%;
    }

    tr:nth-child(even) {
        background-color: #dddddd;
    }

    body {
        padding: 20px;
        min-width: 1100px; 
        width: auto !important;
    }

    </style>

    <script>

    function upd_country(obj)
    {
        if (obj.options[obj.selectedIndex].text == "Select new")
            return;

        document.getElementById("cou").value = obj.options[obj.selectedIndex].value;
    }

    function upd_ntp(obj)
    {
        if (obj.options[obj.selectedIndex].text == "Select new")
            return;

        document.getElementById("ntp").value = obj.options[obj.selectedIndex].value;

    }

    function formatDate(date) {
        var d = new Date(date),
            month = '' + (d.getMonth() + 1),
            day = '' + d.getDate(),
            year = d.getFullYear();

        if (month.length < 2) 
            month = '0' + month;
        if (day.length < 2) 
            day = '0' + day;

        return [year, month, day].join('-');
    }

    function ToLocalDate (inDate) {

        var date = new Date(0);
        return formatDate(date.setUTCSeconds(inDate));
    }

    function setFdate(how)
    {
        var obje = document.getElementById("fage");
        var objeval = parseInt(obje.value, 10);
        var objd = document.getElementById("fdate");
        var curepoch = parseInt(document.getElementById("curepoch").value, 10);
        var epoch;

        if (how == "plus")
            epoch = objeval + 2628288;
        else if (how == 'minus') {
            if (objeval > curepoch + 2628288)
                epoch = objeval - 2628288;
            else
                epoch = objeval;
            }
        else
            return;
          
        obje.value =  epoch;                
        objd.value = ToLocalDate(epoch);

        if (epoch < curepoch + 2628288)
            objd.style.background = "#f40"; 
        else
            objd.style.background = "#fff";
    }

    function showPass()
    {
        var obj = document.getElementById("pass");
        if (obj.type === "password") {
            obj.type = "text";
        } else {
            obj.type = "password";
        }
    }

    function isValidIP(ip)
    {
        var ipaddress = ip.value;
        var patt = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
        var match = ipaddress.match(patt);

        if (ipaddress == "255.255.255.255") {
            return false;
        }

        if (match == null) {
            return false;
        }
           
        return true;
    }

    function isValidSSID(ssid) { 
        var str = ssid.value;

        return /^[!#;].|[+\[\]/"\t\s].*$/.test(str);
    }

    function init()
    {
        var obje = document.getElementById("fage");
        var objd = document.getElementById("fdate");
        var curepoch = parseInt(document.getElementById("curepoch").value, 10);

        objd.value = ToLocalDate(obje.value);

        if (parseInt(obje.value, 10) < curepoch + 2628288)
            objd.style.background = "#f40";

        var couVal = document.getElementById("cou").value;
        var opt = document.getElementById("couopt");

        for(i=0; i<opt.options.length; i++){
            if (opt.options[i].value === couVal) {
                opt.options[i].selected = 'selected';
                break;
            }
        }

        var ntpVal = document.getElementById("ntp").value;
        var opt = document.getElementById("ntpopt");

        for(i=0; i<opt.options.length; i++){
            if (opt.options[i].value === ntpVal) {
                opt.options[i].selected = 'selected';
                break;
            }
        }
       
        var totv = parseInt(document.getElementById("totv").value, 10);
        var tnkv = parseInt(document.getElementById("tnkv").value, 10);
        var vleft = Math.round(((tnkv-totv)/tnkv)*100);
        document.getElementById("totv").title = "volume left " + vleft + "%";  
        document.getElementById("tnkv").title = "volume left " + vleft + "%";       
    }

    function finish()
    {
        var ntpObj = document.getElementById("ntp");
        var ssidObj = document.getElementById("ssid");

        if (isValidIP(ntpObj) == false) {
            alert("Error: Garbled NTP Server I.P Adress");
            return false;
        }

        if (isValidSSID(ssidObj) == true) {
            alert("Error: Garbled SSID string");
            return false;
        }

        return true;
    }

    </script>

</head>

<body onload="init()">

<h1>DigiFlow 242 @ <!--#IPAD-->  <!--#CURTM--></h1>

<form name="form" id="form" method="post" onsubmit="return finish()" action="/index.html">
<input type="hidden" name="fage" id="fage" value="<!--#FAGE-->">
<input type="hidden" id="curepoch" value="<!--#EPOCH-->">
<table>
    <tr>
    <th>Property</th>
    <th>Value</th>
    <th>Description</th>
    </tr>

    <tr>  
        <td><label for="ssid">SSID</label></td>
        <td><input type="text" id="ssid" name="ssid" value="<!--#SSID-->"></td>
        <td>WiFi Network Name&sup1;</td>
    </tr>

    <tr>
        <td><label for="pass">PASS</label></td>
        <td>
            <input type="password" id="pass" name="pass" value="<!--#PASS-->">
            <input type="checkbox" onclick="showPass()">Show Password
        </td>
        <td>WiFi Password&sup1;</td>
    </tr>

    <tr>
        <td><label for="cou">Country Code</label></td>
        <td>
            <input type="text" readonly id="cou" name="cou" value="<!--#COU-->">
            <select name="couopt" id="couopt" title="CountryCode" style="width: 140px;" onchange="upd_country(this)">
                <option selected value="0">Select new</option>
                <option value="21333">USA</option>
                <option value="16967">UK</option>
                <option value="17747">Sweden</option>
                <option value="20302">Norway</option>
                <option value="19268">Denmark</option>
                <option value="18758">Finland</option>
                <!--More? See Pico SDK lib/cyw43-driver/src/cyw43_country.h -->
            </select> 
        </td>
        <td>WiFi Country code&sup1;</td>
    </tr>

    <tr>
        <td><label for="ntp">NTP Server</label></td>
        <td>
            <input type="text" id="ntp" name="ntp" value="<!--#NTP-->">
            <select name="ntpopt" id="ntpopt" title="ntpopt" style="width: 140px;" onchange="upd_ntp(this)">
                <option selected value="0">Select new</option>
                <option value="0.0.0.0">Auto</option>
                <option value="time.google.com">time.google.com</option>
                <option value="time.windows.com">time.windows.com</option>
                <option value="time.apple.com">time.apple.com</option>
            </select> 
        </td>
        <td>0.0.0.0 = Auto (Use the DHCP servers' NTP service)&sup1;</td>
    </tr>

    <tr>
        <td><label for="totv">Total Volume</label></td>
        <td><input type="number"  min="1" title="In Litres" id="totv" name="totv" oninput="validity.valid||(value='');" value="<!--#TOTV-->"></td>
        <td>Volume currently used</td>
    </tr>

    <tr>
        <td><label for="tnkv">Tank Volume</label></td>
        <td><input type="number" min="1" title="In Litres" id="tnkv" name="tnkv" oninput="validity.valid||(value='');" value="<!--#TNKV-->"></td>
        <td>Water Tank volume</td>
    </tr>

    <tr>
      <td><label for="fqv">F/Q Value for Sensor</label></td>
      <td><input type="number" min="4" max="14" title="Float 4-14: 0.5 incr" id="fqv" name="fqv" step="0.5" oninput="validity.valid||(value='');" value="<!--#FQV-->"></td>
    <td>Frequency F=(<!--#FQV-->*Q)Q=L/MIN</td>
    </tr>

    <tr>
        <td><label for="fdate">Filter Replace date</label></td>
        <td>
            <input type="text" readonly id="fdate" name="fdate" value="">
            <button type="button" onclick="setFdate('plus')">+4W</button> 
            <button type="button" onclick="setFdate('minus')">-4W</button> 
        </td>
        <td>Expiration date for filter</td>
    </tr>

    <tr>
        <td><label for="fvol">Filter Volume</label></td>
        <td><input type="number" min="0" title="In Litres" id="fvol" name="fvol" oninput="validity.valid||(value='');" value="<!--#FVOL-->"></td>
        <td>Filter Volume since last replacement</td>
    </tr>

    <tr>
        <td><label for="vers">Firmware Version</label></td>
        <td><input type="text" style="background: lightgray" id="vers" readonly value="<!--#VERS-->"></td>
        <td>Version of this application</td>
    </tr>
    <tr>
        <td><label for="ipad">I.P address</label></td>
        <td><input type="text" title="Device I.P" style="background: lightgray" id="ipad" readonly value="<!--#IPAD-->"></td>
        <td>DHCP I.P address assigned for this device</td>
    </tr>
    <tr>
        <td><label for="ipagw">GW I.P address</label></td>
        <td><input type="text" title="Default gateway" style="background: lightgray" id="ipagw" readonly value="<!--#IPAGW-->"></td>
        <td>DHCP Default gateway I.P assigned for this device</td>
    </tr>
    <tr>
        <td><label for="uptm">Uptime</label></td>
        <td><input type="text" title="Device uptime" style="background: lightgray" id="uptm" readonly value="<!--#UPTM-->"></td>
        <td>Device uptime</td>
    </tr>
 
</table>
<br>
<input type="submit" value="Submit" title="Save changes" style="float: right;">
</form>
<button type="button" title="Undo changes" onclick="location.reload(true)">Refresh</button>

&nbsp;&nbsp;&nbsp;
<a href="/panel.html?tvol=<!--#TNKV-->&tnkv=<!--#TOTV-->&fxd=<!--#FAGE-->&flv=<!--#FVOL-->">About the Control Panel</a>

<p>&sup1; Reboot required.</p>
<p>Changing any of the SSID, PASS and Country Code parameters will result a lost connection the next time this device is
rebooted.<br>You then have to regain the connection by joining your host to that new AP WiFi network.</p>


</body>
</html>

